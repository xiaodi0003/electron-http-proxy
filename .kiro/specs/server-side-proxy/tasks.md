# 实现计划

- [x] 1. 安装依赖和准备工作
  - 安装 socks npm 包用于 SOCKS5 代理支持
  - 安装 fast-check 作为开发依赖用于属性测试
  - 安装 @types/socks 类型定义
  - _需求: 4.2, 4.3_

- [x] 2. 扩展数据模型
  - 在 src-vue/stores/global.ts 中定义 BackendProxyConfig 接口
  - 扩展 ProxySetting 接口添加 backendProxy 可选字段
  - 定义默认值常量
  - _需求: 1.1, 2.1, 3.1, 5.1_

- [x] 3. 创建后端代理配置 UI 组件
  - 创建 src-vue/views/DynamicProxy/components/BackendProxyConfig.vue 组件
  - 实现代理类型选择（直接连接、HTTP、SOCKS5）
  - 实现代理服务器地址输入框
  - 实现代理端口输入框
  - 根据代理类型控制输入框的启用/禁用状态
  - 实现 v-model 双向绑定
  - _需求: 1.3, 1.4, 1.5, 2.1, 2.2, 3.1, 3.2, 6.1, 6.2, 6.3_

- [x]* 3.1 编写 BackendProxyConfig 组件的属性测试
  - **属性 2: 代理类型控制输入框状态**
  - **验证需求: 1.4, 1.5**

- [x]* 3.2 编写 BackendProxyConfig 组件的属性测试
  - **属性 11: 组件事件通知**
  - **验证需求: 6.3**

- [x]* 3.3 编写 BackendProxyConfig 组件的属性测试
  - **属性 12: 组件状态渲染**
  - **验证需求: 6.4**

- [x] 4. 集成后端代理配置到设置对话框
  - 修改 src-vue/views/DynamicProxy/components/SettingDetail.vue
  - 在 formData 中添加 backendProxy 字段并设置默认值
  - 在代理目标输入框后添加 BackendProxyConfig 组件
  - 使用 v-if 控制组件显示（仅当 toProtocol 为 http 或 https 时）
  - 实现组件与表单数据的双向绑定
  - _需求: 1.1, 1.2, 6.2, 6.3_

- [ ]* 4.1 编写设置对话框的属性测试
  - **属性 1: 协议类型控制组件显示**
  - **验证需求: 1.1, 1.2**

- [x] 5. 添加表单验证规则
  - 在 SettingDetail.vue 的 rules 中添加后端代理配置验证
  - 验证当代理类型为 http 或 socks5 时地址不能为空
  - 验证端口号在 1-65535 范围内
  - 显示适当的错误提示信息
  - _需求: 2.3, 2.4, 3.3, 3.4_

- [ ]* 5.1 编写表单验证的属性测试
  - **属性 3: 空地址验证**
  - **验证需求: 2.3, 3.3**

- [ ]* 5.2 编写表单验证的属性测试
  - **属性 4: 端口范围验证**
  - **验证需求: 2.4, 3.4**

- [x] 6. 更新后端持久化逻辑
  - 确认 server/proxySettings.js 能够正确保存和读取 backendProxy 字段
  - 实现向后兼容：读取旧数据时为 backendProxy 设置默认值
  - _需求: 2.5, 3.5, 5.1, 5.2, 5.5_

- [ ]* 6.1 编写持久化的属性测试
  - **属性 5: 配置持久化往返**
  - **验证需求: 2.5, 3.5, 5.1, 5.2**

- [ ]* 6.2 编写数据加载的属性测试
  - **属性 9: 配置加载正确性**
  - **验证需求: 5.3**

- [ ]* 6.3 编写数据删除的属性测试
  - **属性 10: 规则删除完整性**
  - **验证需求: 5.4**

- [x] 7. 实现直接连接逻辑
  - 在 server/doProxy.js 中重构 exeProxy 函数
  - 提取现有的直接连接逻辑到 handleDirectConnection 函数
  - 当 backendProxy 不存在或类型为 direct 时使用直接连接
  - _需求: 4.1_

- [ ]* 7.1 编写直接连接的属性测试
  - **属性 6: 直接连接不使用代理**
  - **验证需求: 4.1**

- [x] 8. 实现 HTTP 代理逻辑
  - 在 server/doProxy.js 中创建 handleHttpProxy 函数
  - 使用 Node.js http/https 模块的 CONNECT 方法
  - 配置请求通过 HTTP 代理服务器
  - 实现错误处理，返回 502 状态码和错误信息
  - _需求: 4.2, 4.4_

- [ ]* 8.1 编写 HTTP 代理的属性测试
  - **属性 7: HTTP 代理连接配置**
  - **验证需求: 4.2**

- [x] 9. 实现 SOCKS5 代理逻辑
  - 在 server/doProxy.js 中创建 handleSocks5Proxy 函数
  - 使用 socks 库建立 SOCKS5 连接
  - 配置请求通过 SOCKS5 代理服务器
  - 实现错误处理，返回 502 状态码和错误信息
  - _需求: 4.3, 4.5_

- [ ]* 9.1 编写 SOCKS5 代理的属性测试
  - **属性 8: SOCKS5 代理连接配置**
  - **验证需求: 4.3**

- [x] 10. 更新 exeProxy 函数调用
  - 修改 server/doProxy.js 中的 proxyReq 函数
  - 从 setting 中提取 backendProxy 配置
  - 将 backendProxy 传递给 exeProxy 函数
  - 确保所有代理路径都正确处理后端代理配置
  - _需求: 4.1, 4.2, 4.3_

- [x] 11. 添加错误处理和日志
  - 在所有代理函数中添加 try-catch 错误捕获
  - 实现统一的错误响应格式
  - 添加详细的日志输出便于调试
  - 确保不在日志中泄露敏感信息
  - _需求: 4.4, 4.5_

- [x] 12. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ]* 13. 编写集成测试
  - 设置测试 HTTP 代理服务器
  - 设置测试 SOCKS5 代理服务器
  - 测试完整的代理流程（UI 配置 → 保存 → 代理请求）
  - 验证请求正确通过配置的代理服务器
  - _需求: 4.1, 4.2, 4.3_
